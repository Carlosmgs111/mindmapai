---
import Layout from "@/layouts/Layout.astro";
import DashBoardLayout from "@/layouts/DashboardLayout.astro";
import LoadedFileSelector from "../components/LoadedFileSelector.astro";
import LibraryFileSelector from "../components/LibraryFileSelector.astro";
import { sc } from "@/shared/utils/sc";
import TimeAgo from "javascript-time-ago";
import es from "javascript-time-ago/locale/es";

TimeAgo.addLocale(es);
const timeAgo = new TimeAgo("es-ES");
const res = await fetch(new URL("/api/file", Astro.url));
const files = await res.json();
---

<Layout title="Archivos | MindMapAI">
  <DashBoardLayout contentClass="pt-8">
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
      <span class="block text-gray-200 mb-2 font-bold text-lg px-4 pb-2 w-full"
        >Agregar archivo</span
      >
      <span
        class="block text-gray-200 mb-2 font-semibold text-sm px-4 pb-2 w-full border-b border-gray-700"
        >Agrega un nuevo archivo PDF a la biblioteca</span
      >
      <LoadedFileSelector uploadEndpoint={"/api/file"} />
    </div>
    <div
      class={sc(
        "text-gray-200 p-6 bg-gray-800 border border-gray-700 rounded-lg",
        files.length === 0 && "hidden"
      )}
    >
      <span class="block text-gray-200 mb-2 font-bold text-lg px-4 pb-2 w-full"
        >Archivos</span
      >
      <span
        class="block text-gray-200 mb-2 font-semibold text-sm px-4 pb-2 w-full border-b border-gray-700"
        >Archivos guardados en la biblioteca</span
      >
     
        <LibraryFileSelector />
      <div
        class={sc(
          "overflow-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-track]:rounded-full ",
          "[&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:w-2",
          "[&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700",
          "dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500"
        )}
      >
        <ul
          data-files={JSON.stringify(files)}
          class="w-full flex flex-wrap table mb-2"
          id="files"
        >
          {
            [
              <li class=" font-bold text-lg table-row ">
                <span class="p-4 w-full font-[500] table-cell">Nombre</span>
                <span class="p-4 whitespace-nowrap table-cell">
                  Ultima modificacion
                </span>
                <span class="p-4 whitespace-nowrap table-cell">TamaÃ±o</span>
                <span class="p-4 whitespace-nowrap table-cell">Acciones</span>
              </li>,
              ...files.map((file: any) => (
                <li
                  id="file-index"
                  data-id={file.id}
                  class="hover:bg-gray-700/30 transition-all table-row border rounded-lg whitespace-nowrap !max-w-[50px]"
                >
                  <span class="p-4 w-full font-[500] table-cell flex justify-between gap-2">
                    <label class="hidden" id="file-is-selected">
                      ðŸ”²
                    </label>
                    <label class=" w-full">{file.name}</label>
                  </span>
                  <span class="p-4 whitespace-nowrap table-cell">
                    {timeAgo.format(file.lastModified)}
                  </span>
                  <span class="p-4 whitespace-nowrap table-cell">
                    {new Intl.NumberFormat("es-ES", {
                      style: "unit",
                      unit: "kilobyte",
                    }).format(Math.round(file.size / 1024))}
                  </span>
                  <div class="flex gap-1 p-4">
                    <button
                      class="h-fit rounded-lg bx bx-file-detail text-gray-500 p-2 hover:bg-gray-500/50 transition-all"
                      name="detail"
                      id={file.id}
                      title="Ver Detalles"
                    />
                    <button
                      class="h-fit rounded-lg bx bx-edit text-gray-500 p-2 hover:bg-gray-500/50 transition-all"
                      name="edit"
                      id={file.id}
                      title="Editar Nombre"
                    />
                    <button
                      id={file.id}
                      name="delete"
                      class="h-fit bx bx-trash text-red-500 p-2 rounded-lg hover:bg-red-500/50 transition-all table-cell"
                      title="Eliminar"
                    />
                  </div>
                </li>
              )),
            ]
          }
        </ul>
      </div>
      <span
        class={sc(
          "block text-gray-200 font-semibold text-2xl px-4 w-full mt-6 text-center",
          files.length > 0 && "opacity-0 pointer-events-none"
        )}>Aun no tienes ningun archivo.</span
      >
    </div>
  </DashBoardLayout>
</Layout>

<script>
  import { selectionMode } from "../stores/selectionMode";
  import { setFiles } from "../stores/files";
  const files = JSON.parse(
    (document.querySelector("#files") as HTMLInputElement)?.dataset.files ||
      "[]"
  );
  const indexes: string[] = [];
  const indexedFiles: { [key: string]: any } = {};
  files.forEach((file: any) => {
    indexedFiles[file.id] = file;
    indexes.push(file.id);
  });
  console.log({ indexedFiles });
  setFiles(indexedFiles);
  // Variable para almacenar las funciones de limpieza
  let cleanupFunctions: (() => void)[] = [];

  const handleDelete = async (id: string) => {
    const result = window.confirm(
      "Esta a punto de eliminar el archivo, esta seguro de continuar?"
    );
    if (result) {
      const res = await fetch(`/api/file/${id}`, {
        method: "DELETE",
      });
      if (res.ok) {
        window.location.reload();
      }
    }
  };

  const handleDetail = async (id: string) => {
    const res = await fetch(`/api/file/${id}`, {
      method: "GET",
    });
    const file = await res.json();
    console.log({ file });
  };

  const setupActionButtons = () => {
    document.querySelectorAll("button[name='delete']").forEach((button) => {
      button.addEventListener("click", (e) => {
        handleDelete((e.target as HTMLButtonElement).id);
      });
    });

    document.querySelectorAll("button[name='detail']").forEach((button) => {
      button.addEventListener("click", (e) => {
        handleDetail((e.target as HTMLButtonElement).id);
      });
    });
  };

  document.addEventListener("astro:page-load", () => {
    const mode = (
      document.querySelector("#mode-select-container") as HTMLInputElement
    ).dataset.mode;
    selectionMode.set(mode === "select");
    setupActionButtons();
  });

  document.addEventListener("astro:before-swap", () => {
    cleanupFunctions.forEach((cleanup) => cleanup());
    cleanupFunctions = [];
  });
</script>
