---
import Layout from "@/layouts/Layout.astro";
import DashBoardLayout from "@/layouts/DashboardLayout.astro";
import LoadedFileSelector from "../components/LoadedFileSelector";
import FileList from "../components/FileList";
import Overlay from "@/shared/components/Overlay/Overlay.astro";

const execEnv = import.meta.env.EXEC_ENV || "server";
console.log("EXEC_ENV:", execEnv);
---

<Layout title="Archivos | Klay">
  <DashBoardLayout contentClass="pt-8">
    <div class="space-y-6 flex flex-col gap-6">
      <!-- Header Section -->
      <div class="flex flex-col gap-2">
        <h1 class="text-3xl font-bold text-slate-100 flex items-center gap-3">
          <i class="bx bxs-file-doc text-blue-400"></i>
          Biblioteca de Archivos
        </h1>
        <p class="text-slate-400 text-sm">
          Gestiona tus documentos PDF y crea mapas mentales a partir de ellos
        </p>
      </div>

      <!-- File List Section -->
      <FileList client:load execEnv={execEnv} />
      <button
        class="bg-blue-500 text-white p-2 rounded-lg inline-flex items-center justify-center gap-2 hover:bg-blue-600 transition-colors duration-300"
        id="open-overlay"
        ><i class="bx bxs-file-plus text-3xl text-slate-100"></i> Agregar Archivo</button
      >
      <!-- Upload Section -->
    </div>
    <Overlay open={false} id="my-overlay">
      <div
        class="bg-gradient-to-br h-full from-slate-800/80 to-slate-800/80 p-8 rounded-xl border border-slate-700/50 shadow-xl backdrop-blur-sm"
      >
        <div class="flex items-center gap-3 mb-4">
          <div class="p-3 bg-blue-500/10 rounded-lg">
            <i class="bx bxs-file-plus text-3xl text-blue-400"></i>
          </div>
          <div>
            <h2 class="text-xl font-semibold text-slate-100">
              Agregar Nuevo Archivo
            </h2>
            <p class="text-slate-400 text-sm mt-1">
              Sube un documento PDF para agregarlo a tu biblioteca
            </p>
          </div>
        </div>
        <div class="mt-6 w-[600px]">
          <LoadedFileSelector client:load uploadEndpoint={"/api/file"} />
        </div>
      </div>
    </Overlay>
  </DashBoardLayout>
</Layout>

<script>
  import { selectionMode } from "../stores/selectionMode";

  document.addEventListener("astro:page-load", () => {
    const modeContainer = document.querySelector(
      "#mode-select-container"
    ) as HTMLInputElement;
    if (modeContainer) {
      const mode = modeContainer.dataset.mode;
      selectionMode.set(mode === "select");
    }
    const openOverlayButton = document.getElementById("open-overlay");
    if (openOverlayButton) {
      openOverlayButton.addEventListener("click", () => {
        const overlay = document.getElementById("my-overlay");
        if (overlay) {
          overlay.setAttribute("data-open", "true");
        }
      });
    }

    const overlay = document.getElementById("my-overlay");
    if (overlay) {
      // Abrir

      // overlay?.setAttribute('data-open', 'true');

      // Cerrar
      // overlay?.setAttribute('data-open', 'false');

      // Escuchar cierre
      overlay?.addEventListener("overlay-close", () => {
        overlay.setAttribute("data-open", "false");
      });
    }
  });
</script>
