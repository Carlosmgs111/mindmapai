---
import { sc } from "@/shared/utils/sc";
const { uploadEndpoint, id  , class:className } = Astro.props;
---

<form id={id} class={sc("flex gap-2 items-center text-gray-200", className)}>
  <input class="hidden" id="fileInput" type="file" name="file" accept=".pdf" />
  <label
    id="fileLabel"
    class="w-full p-4 hover:bg-gray-700/50 rounded-lg overflow-hidden text-ellipsis whitespace-nowrap cursor-pointer border-2 border-dashed border-transparent transition-all"
    for="fileInput"
    ><i id="fileIcon" class="bx bx-folder-open mr-2 align-middle text-xl transition-transform"></i><span id="fileText">Haz clic o arrastra un archivo</span></label
  >
  <button
    data-endpoint={uploadEndpoint}
    class={sc(
      "bg-gray-700/50 hover:bg-gray-700 p-4 rounded-lg whitespace-nowrap",
      !uploadEndpoint && "hidden"
    )}
    id="uploadButton"
    type="submit"
    ><i class="bx bx-folder-up-arrow mr-2 align-middle text-xl"></i>Subir
    archivo</button
  >
</form>

<script>
  import { fileStore, setStagedFiles, setFiles } from "../stores/files";

  document.addEventListener("astro:page-load", () => {
    const fileStored = fileStore.get();
    const fileInput = document.getElementById("fileInput") as HTMLInputElement;
    const uploadButton = document.getElementById("uploadButton");
    const fileLabel = document.getElementById("fileLabel");
    const fileIcon = document.getElementById("fileIcon");
    const fileText = document.getElementById("fileText");

    const updateLabel = () => {
      if (fileText && fileIcon && fileInput?.files && fileInput.files.length > 0) {
        const fileNames = Array.from(fileInput.files)
          .map((file: File) => file.name)
          .join(", ");
        fileIcon.className = "bx bx-folder-open mr-2 align-middle text-xl transition-transform";
        fileText.textContent = fileNames;
      }
    };

    // Restaurar archivo del estado
    if (
      fileStored.stagedIndexes[0] &&
      fileStored.files[fileStored.stagedIndexes[0]] instanceof File
    ) {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(
        fileStored.files[fileStored.stagedIndexes[0]] as File
      );
      fileInput.files = dataTransfer.files;
      updateLabel(); // Actualizar el label después de restaurar
    }

    const uploadFile = async (e: Event) => {
      e.preventDefault();
      const formData = new FormData();

      if (!fileInput || !fileInput.files) {
        return;
      }

      if (fileInput.files.length === 0) {
        window.alert("No se selecciono ningun archivo");
        return;
      }

      const target = e.currentTarget as HTMLButtonElement;
      const uploadEndpoint = target.dataset.endpoint;

      if (!uploadEndpoint) {
        window.alert("No se proporciono un endpoint");
        return;
      }

      Array.from(fileInput.files).forEach((file) => {
        formData.append("file", file);
      });

      const res = await fetch(`${uploadEndpoint}/${crypto.randomUUID()}`, {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        window.location.reload();
      }
    };

    const handleFileChange = (e: Event) => {
      e.preventDefault();

      if (fileText && fileIcon && fileInput?.files && fileInput.files.length > 0) {
        const fileLabelContent = Array.from(fileInput.files).map(
          (file: File) => {
            const fileId = crypto.randomUUID();
            const files = { ...fileStore.get().files, [fileId]: file };
            setFiles(files);
            setStagedFiles([fileId]);
            return file.name;
          }
        );
        fileIcon.className = "bx bx-folder-open mr-2 align-middle text-xl transition-transform";
        fileText.textContent = fileLabelContent.join(", ");
      }
    };

    const handleDragOver = (e: DragEvent) => {
      e.preventDefault();
      fileLabel?.classList.add("bg-gray-700/50", "border-gray-500");
      if (fileIcon && fileText) {
        fileIcon.className = "bx bxs-download mr-2 align-middle text-xl transition-transform scale-110";
        fileText.textContent = "Suelta el archivo aquí";
      }
    };

    const handleDragLeave = (e: DragEvent) => {
      e.preventDefault();
      fileLabel?.classList.remove("bg-gray-700/50", "border-gray-500");
      if (fileIcon && fileText && !fileInput?.files?.length) {
        fileIcon.className = "bx bx-folder-open mr-2 align-middle text-xl transition-transform";
        fileText.textContent = "Haz clic o arrastra un archivo";
      }
    };

    const handleDrop = (e: DragEvent) => {
      e.preventDefault();
      fileLabel?.classList.remove("bg-gray-700/50", "border-gray-500");

      const files = e.dataTransfer?.files;
      if (files && files.length > 0 && fileInput) {
        fileInput.files = files;
        handleFileChange(new Event("change"));
      }
    };

    if (uploadButton) {
      uploadButton.addEventListener("click", uploadFile);
    }

    if (fileInput) {
      fileInput.addEventListener("change", handleFileChange);
    }

    if (fileLabel) {
      fileLabel.addEventListener("dragover", handleDragOver);
      fileLabel.addEventListener("dragleave", handleDragLeave);
      fileLabel.addEventListener("drop", handleDrop);
    }
  });
</script>
