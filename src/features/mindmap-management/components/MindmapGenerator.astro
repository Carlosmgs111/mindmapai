---
import LoadedFileSelector from "@/features/file-management/components/LoadedFileSelector.astro";
import FlowStep from "@/shared/components/FlowStep.astro";
import { sc } from "@/shared/utils/sc";
const fileId = Astro.url.searchParams.get("fileId");
const fileName = Astro.url.searchParams.get("fileName");

const stylesOptions = [
  {
    value: "default",
    label: " Que la IA decida",
    description: "Deja que la IA seleccione el mejor estilo",
  },
  {
    value: "minimalista",
    label: " Minimalista",
    description: "Simple y limpio",
  },
  {
    value: "academico",
    label: " Acad茅mico",
    description: "Enfoque educativo y estructurado",
  },
  {
    value: "ejecutivo",
    label: " Ejecutivo",
    description: "Profesional y orientado a resultados",
  },
  {
    value: "investigador",
    label: " Investigador",
    description: "Detallado y anal铆tico",
  },
];
---

<div>
  <!-- Header Section -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-3">
      <div class="p-2 bg-cyan-600/20 rounded-lg">
        <i class="bx bx-brain text-3xl text-cyan-400"></i>
      </div>
      <div>
        <h1
          class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500"
        >
          Generar Nuevo MindMap
        </h1>
        <p class="text-gray-400 text-sm mt-1">
          Convierte tus documentos en mapas mentales inteligentes
        </p>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="mb-8 px-4">
    <div class="flex items-center justify-between text-xs text-gray-400">
      <span class="flex items-center gap-2">
        <span
          class="w-8 h-8 rounded-full bg-cyan-600/20 border-2 border-cyan-500 flex items-center justify-center text-cyan-400 font-semibold step-indicator"
          data-step="1">1</span
        >
        <span class="hidden sm:inline">Documento</span>
      </span>
      <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
      <span class="flex items-center gap-2">
        <span
          class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center font-semibold step-indicator"
          data-step="2">2</span
        >
        <span class="hidden sm:inline">Estilo</span>
      </span>
      <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
      <span class="flex items-center gap-2">
        <span
          class="w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center font-semibold step-indicator"
          data-step="3">3</span
        >
        <span class="hidden sm:inline">Consulta</span>
      </span>
    </div>
  </div>

  <!-- Steps Container -->
  <div class="flex flex-col gap-6 pl-0 md:pl-2">
    <FlowStep
      title=" Selecciona tu documento"
      help="Carga un nuevo PDF o selecciona uno de tu biblioteca existente"
    >
      <div class="space-y-4">
        <!-- File Options Toggle -->
        <form
          data-file-id={fileId}
          id="file-options"
          class="grid grid-cols-2 gap-3 p-1 bg-gray-900/50 rounded-lg"
        >
          <label class="relative cursor-pointer group">
            <input
              type="radio"
              name="file:options"
              value="upload"
              class="hidden peer"
              checked={fileId === null}
            />
            <span
              class="block p-3 text-center border-2 border-transparent peer-checked:border-cyan-500/50 hover:bg-gray-700/30 rounded-lg peer-checked:bg-cyan-900/20 transition-all duration-200 peer-checked:shadow-lg peer-checked:shadow-cyan-500/10"
            >
              <i
                class="bx bx-cloud-upload text-xl align-middle mb-1 block text-gray-400 peer-checked:text-cyan-400"
              ></i>
              <span class="text-sm font-medium">Cargar nuevo</span>
            </span>
          </label>
          <label class="relative cursor-pointer group">
            <input
              type="radio"
              name="file:options"
              value="library"
              class="hidden peer"
              checked={fileId !== null}
            />
            <span
              class="block p-3 text-center border-2 border-transparent peer-checked:border-cyan-500/50 hover:bg-gray-700/30 rounded-lg peer-checked:bg-cyan-900/20 transition-all duration-200 peer-checked:shadow-lg peer-checked:shadow-cyan-500/10"
            >
              <i
                class="bx bx-library text-xl align-middle mb-1 block text-gray-400 peer-checked:text-cyan-400"
              ></i>
              <span class="text-sm font-medium">Desde biblioteca</span>
            </span>
          </label>
        </form>

        <!-- File Selection Area -->
        <div class="min-h-[80px] transition-all duration-300">
          <LoadedFileSelector
            id="option:upload"
            class={sc("transition-all duration-300", fileId ? "hidden" : "")}
          />
          <a
            id="option:library"
            href="/knowledge/files?mode=select"
            class={sc(
              "flex items-center gap-3 w-full p-4 bg-gray-800/50 hover:bg-gray-700/50 border-2 border-dashed border-gray-600 hover:border-cyan-500/50 rounded-lg transition-all duration-200 group",
              fileId ? "" : "hidden"
            )}
          >
            <i
              class="bx bx-book-bookmark text-2xl text-gray-400 group-hover:text-cyan-400 transition-colors"
            ></i>
            <div class="flex-1 overflow-hidden">
              <p class="text-sm font-medium text-gray-300 truncate">
                {fileId !== null ? fileName : "Seleccionar documento"}
              </p>
              <p class="text-xs text-gray-500">Clic para cambiar</p>
            </div>
            <i
              class="bx bx-right-arrow-alt text-xl text-gray-500 group-hover:text-cyan-400 transition-colors"
            ></i>
          </a>
        </div>
      </div>
    </FlowStep>
    <FlowStep
      title=" Elige el estilo de pensamiento"
      help="El estilo influye en c贸mo la IA estructura y presenta la informaci贸n en el mapa mental"
    >
      <form
        id="style-options"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"
      >
        {
          stylesOptions.map((style) => (
            <label class="cursor-pointer group">
              <input
                type="radio"
                name="style"
                value={style.value}
                class="hidden peer"
                checked={style.value === "default"}
              />
              <div class="relative p-4 bg-gray-800/50 border-2 border-gray-700 peer-checked:border-cyan-500/50 hover:bg-gray-700/50 rounded-lg peer-checked:bg-cyan-900/20 transition-all duration-200 peer-checked:shadow-lg peer-checked:shadow-cyan-500/10">
                <div class="flex items-start gap-3">
                  <span class="text-2xl flex-shrink-0">
                    {style.label.split(" ")[0]}
                  </span>
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-gray-200 peer-checked:text-cyan-300 mb-1">
                      {style.label.substring(style.label.indexOf(" ") + 1)}
                    </p>
                    <p class="text-xs text-gray-400 line-clamp-2">
                      {style.description}
                    </p>
                  </div>
                </div>
                <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                  <i class="bx bx-check-circle text-cyan-400 text-lg" />
                </div>
              </div>
            </label>
          ))
        }
      </form>
    </FlowStep>
    <FlowStep
      title=" Describe tu enfoque"
      help="Opcional: Especifica qu茅 aspecto del documento te interesa explorar"
    >
      <div class="relative">
        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
          <i class="bx bx-message-square-dots text-xl"></i>
        </div>
        <input
          id="query"
          class="w-full pl-12 pr-4 py-3 bg-gray-800/50 border-2 border-gray-700 text-gray-200 rounded-lg outline-none focus:outline-none focus:border-cyan-500/50 focus:bg-gray-800 transition-all duration-200 placeholder-gray-500"
          type="text"
          placeholder="Ej: Enf贸cate en los conceptos principales, Resume las ideas clave..."
        />
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
          <span id="char-count" class="text-xs text-gray-500">0/200</span>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
        <i class="bx bx-info-circle"></i>
        <span>Deja vac铆o para un an谩lisis general del documento</span>
      </p>
    </FlowStep>

    <!-- Generate Button -->
    <div class="mt-6 pt-6 border-t border-gray-700/50">
      <button
        id="generate"
        class="w-full relative overflow-hidden bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-gray-700 disabled:to-gray-700 text-white font-semibold p-4 rounded-lg transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] disabled:cursor-not-allowed disabled:transform-none shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 group"
        disabled
      >
        <span class="relative z-10 flex items-center justify-center gap-3">
          <i class="bx bx-brain text-2xl group-hover:animate-pulse"></i>
          <span class="text-lg">Generar MindMap</span>
          <i
            class="bx bx-right-arrow-alt text-xl group-hover:translate-x-1 transition-transform"
          ></i>
        </span>
        <div
          class="absolute inset-0 bg-gradient-to-r from-cyan-400 to-blue-400 opacity-0 group-hover:opacity-20 transition-opacity duration-300"
        >
        </div>
      </button>

      <!-- Loading State -->
      <div
        id="loading-state"
        class="hidden mt-4 p-4 bg-cyan-900/20 border border-cyan-500/30 rounded-lg"
      >
        <div class="flex items-center gap-3">
          <div class="animate-spin">
            <i class="bx bx-loader-alt text-2xl text-cyan-400"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-semibold text-cyan-300">
              Generando tu mapa mental...
            </p>
            <p class="text-xs text-gray-400 mt-1">
              Esto puede tomar unos momentos
            </p>
          </div>
        </div>
      </div>

      <!-- Validation Messages -->
      <div
        id="validation-message"
        class="hidden mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg"
      >
        <div class="flex items-start gap-2">
          <i class="bx bx-error text-yellow-400 text-lg flex-shrink-0 mt-0.5"
          ></i>
          <p class="text-sm text-yellow-200"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    fileStore,
    setFiles,
    setStagedFiles,
  } from "@/features/file-management/stores/files";
  import { queryStore } from "@/features/mindmap-management/stores/query";
  import type { IndexFile } from "@/features/file-management/stores/files";
  const params = new URLSearchParams(window.location.search);
  const fileId = params.get("fileId");
  const fileName = params.get("fileName");

  if (fileId && fileName) {
    setFiles({
      [fileId]: {
        id: fileId,
        name: fileName,
      },
    });
    setStagedFiles([fileId]);
  }
  const fileOptions = document.getElementById(
    "file-options"
  ) as HTMLFormElement;
  const generateBtn = document.getElementById("generate") as HTMLButtonElement;
  const optionUpload = document.getElementById(
    "option:upload"
  ) as HTMLFormElement;
  const optionLibrary = document.getElementById(
    "option:library"
  ) as HTMLFormElement;
  const styleOptions = document.getElementById(
    "style-options"
  ) as HTMLFormElement;
  const query = document.getElementById("query") as HTMLInputElement;
  const charCount = document.getElementById("char-count");
  const loadingState = document.getElementById("loading-state");
  const validationMessage = document.getElementById("validation-message");
  const stepIndicators = document.querySelectorAll(".step-indicator");

  // Validation state
  let validationState = {
    fileSelected: false,
    styleSelected: true, // Default is already selected
  };

  // Update step indicators
  const updateStepIndicator = (step: number, isActive: boolean) => {
    const indicator = Array.from(stepIndicators).find(
      (el) => (el as HTMLElement).dataset.step === step.toString()
    ) as HTMLElement;
    if (indicator) {
      if (isActive) {
        indicator.classList.remove("bg-gray-700", "border-gray-600");
        indicator.classList.add(
          "bg-cyan-600/20",
          "border-cyan-500",
          "text-cyan-400"
        );
      } else {
        indicator.classList.remove(
          "bg-cyan-600/20",
          "border-cyan-500",
          "text-cyan-400"
        );
        indicator.classList.add("bg-gray-700", "border-gray-600");
      }
    }
  };

  // Show validation message
  const showValidation = (message: string) => {
    if (validationMessage) {
      const messageText = validationMessage.querySelector("p");
      if (messageText) {
        messageText.textContent = message;
      }
      validationMessage.classList.remove("hidden");
      setTimeout(() => {
        validationMessage.classList.add("hidden");
      }, 3000);
    }
  };

  // Validate form
  const validateForm = () => {
    const fileIndex: IndexFile = fileStore.get();
    validationState.fileSelected = fileIndex.stagedIndexes.length > 0;

    const isValid =
      validationState.fileSelected && validationState.styleSelected;
    generateBtn.disabled = !isValid;

    return isValid;
  };

  const onChangeFileOptions = (e: Event) => {
    const target = e.currentTarget as HTMLFormElement;
    const fileOption = target.querySelector(
      'input[name="file:options"]:checked'
    ) as HTMLInputElement;

    if (fileOption.value === "library") {
      optionUpload.classList.add("hidden");
      optionLibrary.classList.remove("hidden");
    } else {
      optionUpload.classList.remove("hidden");
      optionLibrary.classList.add("hidden");
    }

    validateForm();
  };

  const onChangeStyleOptions = (e: Event) => {
    const target = e.currentTarget as HTMLFormElement;
    const styleOption = target.querySelector(
      'input[name="style"]:checked'
    ) as HTMLInputElement;
    queryStore.set({
      query: queryStore.get().query,
      style: styleOption.value,
    });
    updateStepIndicator(2, true);
    validationState.styleSelected = true;
    validateForm();
  };

  const onChangeQuery = (e: Event) => {
    const target = e.currentTarget as HTMLInputElement;
    const value = target.value.slice(0, 200); // Limit to 200 chars
    target.value = value;

    if (charCount) {
      charCount.textContent = `${value.length}/200`;
      if (value.length > 150) {
        charCount.classList.add("text-yellow-400");
        charCount.classList.remove("text-gray-500");
      } else {
        charCount.classList.remove("text-yellow-400");
        charCount.classList.add("text-gray-500");
      }
    }

    queryStore.set({
      query: value,
      style: queryStore.get().style,
    });

    updateStepIndicator(3, value.length > 0);
  };
  const generateMindmap = async () => {
    if (!validateForm()) {
      showValidation("Por favor, selecciona un documento antes de continuar");
      return;
    }

    // Show loading state
    generateBtn.disabled = true;
    if (loadingState) {
      loadingState.classList.remove("hidden");
    }

    try {
      const formData = new FormData();
      const fileIndex: IndexFile = fileStore.get();
      let body: any = JSON.stringify({ fileId: fileIndex.stagedIndexes[0] });
      let headers: any = { "Content-Type": "application/json" };
      const file = fileIndex.files[fileIndex.stagedIndexes[0]];

      if (!file) {
        showValidation("No se seleccion贸 ning煤n archivo");
        return;
      }

      if (file instanceof File) {
        formData.append("file", file);
        formData.append("id", fileIndex.stagedIndexes[0]);
        formData.append("chunkingStrategy", "fixed");
        body = formData;
        headers = {};
      }

      const res = await fetch(`/api/knowledge/${crypto.randomUUID()}`, {
        method: "POST",
        body,
        headers,
      });

      const data = await res.json();

      if (res.ok) {
        // Success - could navigate to editor or show success message
        console.log("Mindmap generated successfully", data);
        // window.location.href = "/editor";
      } else {
        showValidation(data.message || "Error al generar el mapa mental");
      }
    } catch (error) {
      console.error("Error generating mindmap:", error);
      showValidation("Error de conexi贸n. Por favor, intenta de nuevo");
    } finally {
      generateBtn.disabled = false;
      if (loadingState) {
        loadingState.classList.add("hidden");
      }
    }
  };
  const onPageLoad = () => {
    // Subscribe to query store changes
    queryStore.subscribe((value) => {
      console.log("Query state:", value);
    });

    // Subscribe to file store changes for validation
    fileStore.subscribe((value) => {
      validationState.fileSelected = value.stagedIndexes.length > 0;
      updateStepIndicator(1, validationState.fileSelected);
      validateForm();
    });

    // Initial validation
    validateForm();

    // Event listeners
    generateBtn.addEventListener("click", generateMindmap);
    fileOptions && fileOptions.addEventListener("change", onChangeFileOptions);
    styleOptions &&
      styleOptions.addEventListener("change", onChangeStyleOptions);
    query && query.addEventListener("input", onChangeQuery);

    // Set initial step indicator for style (default is selected)
    updateStepIndicator(2, true);

    // Check if file is already selected from URL params
    if (fileId && fileName) {
      updateStepIndicator(1, true);
      validationState.fileSelected = true;
      validateForm();
    }
  };

  document.addEventListener("astro:page-load", onPageLoad);
  document.addEventListener("astro:page-unload", () => {
    fileOptions &&
      fileOptions.removeEventListener("change", onChangeFileOptions);
    styleOptions &&
      styleOptions.removeEventListener("change", onChangeStyleOptions);
    query && query.removeEventListener("change", onChangeQuery);
  });
</script>

<style>
  /* Smooth animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateX(-10px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Apply animations */
  .flow-step-content {
    animation: fadeIn 0.4s ease-out;
  }

  /* Enhance focus states */
  input:focus {
    box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
  }

  /* Smooth transitions for radio buttons */
  input[type="radio"]:checked + span {
    animation: slideIn 0.2s ease-out;
  }

  /* Loading pulse animation */
  #loading-state {
    animation: fadeIn 0.3s ease-out;
  }

  /* Character count color transition */
  #char-count {
    transition: color 0.2s ease;
  }

  /* Step indicator smooth transitions */
  .step-indicator {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Hover effects */
  button:not(:disabled):hover {
    box-shadow: 0 8px 20px -4px rgba(6, 182, 212, 0.3);
  }

  button:not(:disabled):active {
    box-shadow: 0 4px 12px -2px rgba(6, 182, 212, 0.3);
  }

  /* Disabled state */
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Tooltip animations */
  .tooltip {
    animation: fadeIn 0.2s ease-out;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(31, 41, 55, 0.5);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.8);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(107, 114, 128, 0.8);
  }

  /* Text truncate with ellipsis */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
