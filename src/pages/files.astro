---
import Layout from "../layouts/Layout.astro";
import DashBoardLayout from "../layouts/DashboardLayout.astro";
import FileSelector from "../components/FileSelector.astro";
import Switch from "../components/Switch.astro";
import { sc } from "../utils/sc";
import TimeAgo from "javascript-time-ago";
import es from "javascript-time-ago/locale/es";
import { selectionMode } from "../stores/selectionMode";
import { fileSelected } from "../stores/fileSelected";

TimeAgo.addLocale(es);
const timeAgo = new TimeAgo("es-ES");
const res = await fetch(new URL("/api/file", Astro.url));
const files = await res.json();
---

<Layout title="Archivos | MindMapAI">
  <DashBoardLayout>
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
      <span class="block text-gray-200 mb-2 font-bold text-lg px-4 pb-2 w-full"
        >Agregar archivo</span
      >
      <span
        class="block text-gray-200 mb-2 font-semibold text-sm px-4 pb-2 w-full border-b border-gray-700"
        >Agrega un nuevo archivo PDF a la biblioteca</span
      >
      <FileSelector uploadEndpoint={"/api/file"} />
    </div>
    <div
      class={sc(
        "text-gray-200 p-6 bg-gray-800 border border-gray-700 rounded-lg",
        files.length === 0 && "hidden"
      )}
    >
      <span class="block text-gray-200 mb-2 font-bold text-lg px-4 pb-2 w-full"
        >Archivos</span
      >
      <span
        class="block text-gray-200 mb-2 font-semibold text-sm px-4 pb-2 w-full border-b border-gray-700"
        >Archivos guardados en la biblioteca</span
      >
      <div
        class="px-4 py-2 border-b border-gray-700 flex flex-wrap gap-2 sticky top-0 z-10 bg-gray-800"
      >
        <div class="flex gap-2 w-full items-center">
          <div class="w-full">
            <Switch id="mode-select" label="Activar seleccion de archivo" />
          </div>
          <button
            id="mode-select:add-file"
            class={sc(
              "bg-gray-700/50 text-sm hover:bg-gray-700 py-2 px-4 rounded-lg whitespace-nowrap",
              selectionMode.get() && !Boolean(fileSelected.get()) && "disabled:opacity-50 disabled:cursor-not-allowed",
              !selectionMode.get() && Boolean(fileSelected.get()) && "opacity-0 pointer-events-none"
            )}
          >
            <i class="bx bx-arrow-to-right-stroke mr-2 align-middle text-xl"
            ></i> Continuar
          </button>
        </div>
        <span class="text-xs w-full"
          >Activa el modo de seleccion para agregar un archivo de la biblioteca
          al contexto</span
        >
      </div>
      <div class="overflow-auto">
        <ul class="w-full flex flex-wrap table" id="files">
          {
            [
              <li class=" font-bold text-lg table-row ">
                <span class="p-4 w-full font-[500] table-cell">Nombre</span>
                <span class="p-4 whitespace-nowrap table-cell">
                  Ultima modificacion
                </span>
                <span class="p-4 whitespace-nowrap table-cell">TamaÃ±o</span>
                <span class="p-4 whitespace-nowrap table-cell">Acciones</span>
              </li>,
              ...files.map((file: any) => (
                <li
                  id="file-index"
                  data-id={file.id}
                  class="hover:bg-gray-700/30 transition-all table-row border rounded-lg whitespace-nowrap !max-w-[50px]"
                >
                  <span class="p-4 w-full font-[500]table-cell flex justify-between gap-2">
                    <label
                      class={sc(!selectionMode.get() && "hidden")}
                      id="file-is-selected"
                    >
                      ðŸ”²
                    </label>
                    <label class=" w-full">{file.name}</label>
                  </span>
                  <span class="p-4 whitespace-nowrap table-cell">
                    {timeAgo.format(file.lastModified)}
                  </span>
                  <span class="p-4 whitespace-nowrap table-cell">
                    {new Intl.NumberFormat("es-ES", {
                      style: "unit",
                      unit: "kilobyte",
                    }).format(Math.round(file.size / 1024))}
                  </span>
                  <div class="flex gap-1 p-4">
                    <button
                      class="h-fit rounded-lg bx bx-file-detail text-gray-500 p-2 hover:bg-gray-500/50 transition-all"
                      name="detail"
                      id={file.id}
                      title="Ver Detalles"
                    />
                    <button
                      class="h-fit rounded-lg bx bx-edit text-gray-500 p-2 hover:bg-gray-500/50 transition-all"
                      name="edit"
                      id={file.id}
                      title="Editar Nombre"
                    />
                    <button
                      id={file.id}
                      name="delete"
                      class="h-fit bx bx-trash text-red-500 p-2 rounded-lg hover:bg-red-500/50 transition-all table-cell"
                      title="Eliminar"
                    />
                  </div>
                </li>
              )),
            ]
          }
        </ul>
      </div>
      <span
        class={sc(
          "block text-gray-200 font-semibold text-2xl px-4 w-full mt-6 text-center",
          files.length > 0 && "opacity-0 pointer-events-none"
        )}>Aun no tienes ningun archivo.</span
      >
    </div>
  </DashBoardLayout>

  <script>
    import { selectionMode } from "../stores/selectionMode";
    import { fileSelected } from "../stores/fileSelected";
    import { navigate } from "astro:transitions/client";

    document.addEventListener("astro:page-load", () => {
      const fileIndexes = document.querySelectorAll("#file-index");
      const labels = document.querySelectorAll("#file-is-selected");
      const selectButton = document.getElementById(
        "mode-select:add-file"
      ) as HTMLButtonElement;

      fileIndexes.forEach((li) => {
        li.addEventListener("click", () => {
          if (!selectionMode.get()) return;
          if (fileSelected.get() === (li as HTMLElement).dataset.id) {
            fileSelected.set(null);
            return;
          }
          fileSelected.set((li as HTMLElement).dataset.id as string);
        });
      });

      fileSelected.subscribe((value) => {
        selectButton.disabled = Boolean(!value);
        fileIndexes.forEach((li) => {
          const label = li.querySelector("#file-is-selected");
          if ((li as HTMLElement).dataset.id === value) {
            li.classList.add("bg-gray-700/50");
            if (label) label.textContent = "âœ…";
            return;
          }
          li.classList.remove("bg-gray-700/50");
          if (label) label.textContent = "ðŸ”²";
        });
      });
      selectionMode.subscribe((value) => {
        selectButton?.classList.toggle("opacity-0", !value);
        selectButton?.classList.toggle("disabled:opacity-50", value);
        selectButton?.classList.toggle("disabled:cursor-not-allowed", value);
        selectButton?.classList.toggle("pointer-events-none", !value);
        fileSelected.set(null);
        labels.forEach((label) => {
          label.classList.toggle("hidden", !value);
        });
      });

      selectButton.addEventListener("click", () => {
        navigate(`/generator`);
      });
    });

    const deleteFile = async (id: string) => {
      const res = await fetch(`/api/file/${id}`, {
        method: "DELETE",
      });
      if (res.ok) {
        window.location.reload();
      }
    };

    document.addEventListener("click", (e) => {
      if ((e.target as HTMLButtonElement).name === "delete") {
        deleteFile((e.target as HTMLButtonElement).id);
      }
    });
    document.querySelectorAll("button[name='delete']").forEach((button) => {
      button.addEventListener("click", (e) => {
        const result = window.confirm(
          "Esta a punto de eliminar el archivo, esta seguro de continuar?"
        );
        if (result) {
          deleteFile((e.target as HTMLButtonElement).id);
        }
      });
    });
    const detailFile = async (id: string) => {
      const res = await fetch(`/api/file/${id}`, {
        method: "GET",
      });
      const file = await res.json();
      console.log({ file });
    };
    document.querySelectorAll("button[name='detail'").forEach((button) => {
      button.addEventListener("click", (e) => {
        detailFile((e.target as HTMLButtonElement).id);
      });
    });
  </script>
</Layout>
